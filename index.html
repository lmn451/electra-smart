<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Electra Control</title>
    <meta
      name="description"
      content="Control your Electra air conditioning units remotely with this smart home PWA"
    />
    <meta
      name="keywords"
      content="electra, air conditioning, smart home, pwa, remote control"
    />

    <!-- PWA Theme Colors -->
    <meta name="theme-color" content="#0f172a" />
    <meta name="msapplication-TileColor" content="#0f172a" />
    <meta name="msapplication-config" content="./icons/browserconfig.xml" />

    <!-- Apple iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Electra" />

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon-180x180.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon-180x180.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512.png" />

    <!-- Standard Icons -->
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./icons/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="./icons/icon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="./icons/icon-512.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="72x72"
      href="./icons/icon-72x72.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="./icons/icon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="128x128"
      href="./icons/icon-128x128.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="144x144"
      href="./icons/icon-144x144.png"
    />

    <!-- Windows Tile Icon -->
    <meta name="msapplication-TileImage" content="./icons/mstile-150x150.png" />

    <!-- Manifest and Styles -->
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main>
      <h1>Electra Control</h1>

      <div id="loginPanel" class="panel">
        <div class="auth-panel" id="authPanel">
          <h2>Sign in</h2>

          <div class="auth-step" id="stepPhone">
            <label for="phoneInput">Phone</label>
            <input
              type="tel"
              id="phoneInput"
              placeholder="05XXXXXXXX"
              inputmode="tel"
              autocomplete="tel"
            />
            <button id="sendOtpBtn" class="btn primary">Send code</button>
          </div>

          <div class="auth-step hidden" id="stepCode">
            <p class="muted">
              Enter the 4-digit code sent to <strong id="phoneEcho"></strong>
            </p>
            <div class="otp-grid" role="group" aria-label="One-time code">
              <input
                id="otp-1"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
                autocomplete="one-time-code"
              />
              <input
                id="otp-2"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
              />
              <input
                id="otp-3"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
              />
              <input
                id="otp-4"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
              />
            </div>
            <div class="auth-row">
              <label class="remember">
                <input type="checkbox" id="rememberChk" /> Remember me
              </label>
            </div>
            <div class="auth-actions">
              <button id="verifyBtn" class="btn primary">Verify</button>
              <button id="resendBtn" class="btn secondary" disabled>
                Resend
              </button>
              <span id="resendCountdown" class="muted"></span>
            </div>
            <div class="auth-links">
              <button id="editPhoneLink" class="linklike" type="button">
                Edit phone
              </button>
            </div>
          </div>

          <span id="authStatus" class="status"></span>
        </div>
      </div>

      <div class="auth-actions hidden" id="logoutRow">
        <button id="logoutBtn" class="btn secondary">Logout</button>
      </div>

      <div id="controlsLoading" class="loading-spinner hidden"></div>

      <div class="toolbar hidden" id="toolbar">
        <button id="refresh">Refresh All</button>
        <span id="statusLine" class="status"></span>
      </div>

      <!-- Device card template for declarative rendering -->
      <template id="device-card-template">
        <div class="card">
          <div class="header">
            <div class="title" data-bind="title"></div>
            <div class="header-right">
              <div class="badge" data-bind="badge">—</div>
              <button class="icon-btn" data-action="refresh" title="Refresh device" aria-label="Refresh device">↻</button>
            </div>
          </div>

          <div class="grid">
            <div class="kv">
              <span class="k">Mode</span>
              <span data-bind="mode">—</span>
            </div>
            <div class="kv">
              <span class="k">Fan</span>
              <span data-bind="fan">—</span>
            </div>
            <div class="kv">
              <span class="k">Setpoint</span>
              <span data-bind="spt">—</span>
            </div>
            <div class="kv">
              <span class="k">Current</span>
              <span data-bind="cur">—</span>
            </div>
          </div>

          <div class="controls controls-erg">
            <div class="controls-left">
              <select data-bind="mode-select">
                <option value="">Mode…</option>
                <option value="STBY">STBY (Standby)</option>
                <option value="COOL">COOL</option>
                <option value="FAN">FAN</option>
                <option value="DRY" selected>DRY</option>
                <option value="HEAT">HEAT</option>
                <option value="AUTO">AUTO</option>
              </select>

              <select data-bind="fan-select">
                <option value="">Fan…</option>
                <option value="LOW" selected>LOW</option>
                <option value="MED">MED</option>
                <option value="HIGH">HIGH</option>
                <option value="AUTO">AUTO</option>
              </select>
            </div>

            <div class="controls-right tempctl-erg">
              <input type="number" data-bind="temp-input" inputmode="numeric" placeholder="Temp °C" min="10" max="35" step="1" />
              <div class="temp-vert">
                <button class="btn temp-inc" data-action="temp-inc">+</button>
                <button class="btn temp-dec" data-action="temp-dec">−</button>
              </div>
              <button class="btn power-btn power-under" data-action="power-toggle" aria-pressed="false" aria-label="Power">⏻</button>
            </div>
          </div>

          <div class="status-indicator" data-bind="status-indicator"></div>
        </div>
      </template>

      <div id="devices" class="cards"></div>
    </main>

    <script src="./app.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        const swUrl = `/service-worker.js?v=${Date.now()}`; // cache-bust SW file on every load
        navigator.serviceWorker
          .register(swUrl)
          .then((registration) => {
            console.log("Service Worker registered successfully");

            // Force an update check on load
            try { registration.update(); } catch {}

            // Also check when tab becomes visible
            document.addEventListener("visibilitychange", () => {
              if (!document.hidden) {
                try { registration.update(); } catch {}
              }
            });

            // If an updated SW is already waiting, activate it immediately
            if (registration.waiting) {
              registration.waiting.postMessage({ action: "skipWaiting" });
            }

            // Auto-activate newly installed SWs
            registration.addEventListener("updatefound", () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener("statechange", () => {
                  if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                    registration.waiting?.postMessage({ action: "skipWaiting" });
                  }
                });
              }
            });
          })
          .catch((error) => {
            console.error("Service Worker registration failed:", error);
          });

        // Optional: version.json check to detect new deployments even if SW doesn't change
        fetch("/version.json", { cache: "no-store" })
          .then((r) => r.ok ? r.json() : null)
          .then((v) => {
            if (!v || !v.version) return;
            const prev = localStorage.getItem("pwaVersion");
            if (prev && prev !== v.version) {
              // Trigger SW update; SW will auto-activate and controllerchange will reload
              navigator.serviceWorker.getRegistration().then((reg) => reg?.update?.());
            }
            localStorage.setItem("pwaVersion", v.version);
          })
          .catch(() => {});

        // Reload when the new controller takes over
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          window.location.reload();
        });
      }
    </script>
  </body>
</html>
