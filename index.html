<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Electra Control</title>
    <meta name="description" content="Control your Electra air conditioning units remotely with this smart home PWA" />
    <meta name="keywords" content="electra, air conditioning, smart home, pwa, remote control" />

    <!-- PWA Theme Colors -->
    <meta name="theme-color" content="#0f172a" />
    <meta name="msapplication-TileColor" content="#0f172a" />

    <!-- Apple iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Electra" />

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512.png" />

    <!-- Standard Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />

    <!-- Manifest and Styles -->
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main>
      <h1>Electra Control</h1>

      <div id="loginPanel" class="panel">
        <div class="auth-panel" id="authPanel">
          <h2>Sign in</h2>

          <div class="auth-step" id="stepPhone">
            <label for="phoneInput">Phone</label>
            <input
              type="tel"
              id="phoneInput"
              placeholder="05XXXXXXXX"
              inputmode="tel"
              autocomplete="tel"
            />
            <button id="sendOtpBtn" class="btn primary">Send code</button>
          </div>

          <div class="auth-step hidden" id="stepCode">
            <p class="muted">
              Enter the 4-digit code sent to <strong id="phoneEcho"></strong>
            </p>
            <div class="otp-grid" role="group" aria-label="One-time code">
              <input
                id="otp-1"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
                autocomplete="one-time-code"
              />
              <input
                id="otp-2"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
              />
              <input
                id="otp-3"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
              />
              <input
                id="otp-4"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="1"
              />
            </div>
            <input
              type="text"
              id="imeiOutput"
              readonly
              class="visually-hidden"
              aria-hidden="true"
              tabindex="-1"
            />
            <div class="auth-row">
              <label class="remember">
                <input type="checkbox" id="rememberChk" /> Remember me
              </label>
            </div>
            <div class="auth-actions">
              <button id="verifyBtn" class="btn primary">Verify</button>
              <button id="resendBtn" class="btn secondary" disabled>
                Resend
              </button>
              <span id="resendCountdown" class="muted"></span>
            </div>
            <div class="auth-links">
              <button id="editPhoneLink" class="linklike" type="button">
                Edit phone
              </button>
            </div>
          </div>

          <span id="authStatus" class="status"></span>
        </div>
      </div>

      <div id="controlsPanel" class="panel hidden">
        <div class="auth-actions hidden" id="logoutRow">
          <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>

        <div id="controlsLoading" class="loading-spinner hidden"></div>

        <div class="toolbar hidden" id="toolbar">
          <button id="refresh">Refresh All</button>
          <label>
            <input type="checkbox" id="autoRefreshChk" checked /> Auto-refresh
          </label>

          <span id="autoStatus" class="status"></span>
          <span id="statusLine" class="status"></span>
        </div>

        <div id="devices" class="cards"></div>
      </div>
    </main>

    <script src="./app.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then((registration) => {
            console.log("Service Worker registered successfully");

            // Handle service worker updates
            registration.addEventListener("updatefound", () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener("statechange", () => {
                  if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
                    // New version available, show update prompt
                    if (confirm("A new version of Electra Control is available. Update now?")) {
                      newWorker.postMessage({ action: "skipWaiting" });
                      window.location.reload();
                    }
                  }
                });
              }
            });
          })
          .catch((error) => {
            console.error("Service Worker registration failed:", error);
          });

        // Listen for service worker messages
        navigator.serviceWorker.addEventListener("message", (event) => {
          if (event.data && event.data.action === "reload") {
            window.location.reload();
          }
        });

        // Handle service worker controller changes
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          window.location.reload();
        });
      }
    </script>
  </body>
</html>
